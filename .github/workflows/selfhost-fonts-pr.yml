on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  fetch-fonts-and-pr:
    runs-on: ubuntu-latest
    name: Fetch Google Fonts and open PR
    steps:
      - name: Checkout (with token)
        uses: actions/checkout@v4
        with:
          # ensure we have write access to push branches
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Prepare directories
        run: mkdir -p assets/fonts

      - name: Fetch Google Fonts CSS
        env:
          GOOGLE_FONTS_CSS: "https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto:wght@400;500&display=swap"
        run: |
          set -euo pipefail
          curl -s -A "Mozilla/5.0 (compatible;)" "$GOOGLE_FONTS_CSS" -o /tmp/gf.css
          echo "Saved /tmp/gf.css (size: $(stat -c%s /tmp/gf.css) bytes)"

      - name: Extract and download font files
        run: |
          set -euo pipefail
          grep -oE "url\([^)]+\)" /tmp/gf.css | sed -E "s/url\((https?:[^)]*)\)/\1/" | sed 's/^"//' | sed "s/^'//" | sed 's/"$//' | sed "s/'$//" | sort -u > /tmp/font-urls.txt || true
          echo "Font URLs:"
          sed -n '1,200p' /tmp/font-urls.txt || true
          while IFS= read -r url; do
            [ -z "$url" ] && continue
            fname=$(basename "${url%%\?*}")
            if [ ! -f "assets/fonts/$fname" ]; then
              echo "Downloading $url -> assets/fonts/$fname"
              curl -fL "$url" -o "assets/fonts/$fname"
            else
              echo "Already exists: assets/fonts/$fname"
            fi
          done < /tmp/font-urls.txt || true

      - name: Generate fonts.css (local refs + font-display)
        run: |
          python3 scripts/selfhost_fonts.py /tmp/gf.css assets/fonts/fonts.css
          echo "=== fonts.css head ==="
          sed -n '1,160p' assets/fonts/fonts.css || true

      - name: Build PR branch name
        run: |
          PR_BRANCH="fonts/selfhost-$(date +'%Y%m%d-%H%M%S')"
          echo "PR_BRANCH=${PR_BRANCH}" >> $GITHUB_ENV
          echo "Created PR_BRANCH=${PR_BRANCH}"

      - name: Configure git with token-authenticated remote
        run: |
          # set git user
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          # replace origin remote with token-authenticated url to ensure push works
          REPO="${GITHUB_REPOSITORY}"
          echo "Setting remote to use token auth for ${REPO}"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.git"
          git remote -v

      - name: Create branch, commit and push
        run: |
          set -euo pipefail
          echo "Using branch: $PR_BRANCH"
          # create branch and commit
          git checkout -b "$PR_BRANCH"
          git add assets/fonts || true
          git commit -m "chore: add self-hosted fonts (auto-generated)" || echo "no changes to commit"
          # push new branch
          git push --set-upstream origin "$PR_BRANCH"

      - name: Create Pull Request via API
        run: |
          TITLE="chore: add self-hosted fonts (auto PR)"
          BODY="This PR contains self-hosted font files and assets/fonts/fonts.css generated by GitHub Actions for offline/self-hosted font delivery."
          API="https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls"
          PAYLOAD=$(jq -n --arg t "$TITLE" --arg b "$BODY" --arg head "$PR_BRANCH" --arg base "main" '{title:$t, body:$b, head:$head, base:$base}')
          echo "Creating PR with payload: $PAYLOAD"
          resp=$(curl -s -X POST -H "Authorization: token ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" "$API" -d "$PAYLOAD")
          echo "$resp"
